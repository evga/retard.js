function t(t,e){if(!t)throw new Error(e??"assert fail")}class e{constructor(){this.cnt=0,this.sum=0,this.vmin=null,this.vmax=null,this.avg=0}counter(){this.cnt++}update(t){this.cnt++,this.sum+=t,this.vmin=null===this.vmin?t:Math.min(t,this.vmin),this.vmax=null===this.vmax?t:Math.max(t,this.vmax),this.avg=this.cnt>0?this.sum/this.cnt:0}}const n=new class{#t=[];constructor(){}push(t){this.#t.push(t)}pop(){if(0===this.#t.length)throw new Error("unbalanced stack");return this.#t.pop()}get length(){return this.#t.length}get current(){return this.#t[this.#t.length-1]}};var i=!0;const s=Symbol("stop"),r=[];class a{#e=!1;description;userCallback;constructor(n){t(n instanceof Function),this.callback=n,i&&(this.executeStats=new e,r.push(this))}stop(){this.#e=!0}execute(...t){const e=performance.now();if(this.#e)return s;n.push(this);try{return this.callback(...t)}finally{n.pop(),this.executeStats&&this.executeStats.update(performance.now()-e)}}}function o(t){return new a(t)}const c=[];class l{constructor(t){this.initialValue=t,this.value=t,this.callbacks=new Set,this.resetBound=this.reset.bind(this),i&&(this.readStats=new e,this.writeStats=new e,this.changedStats=new e,c.push(this))}#n(){const t=n.current;t&&!this.callbacks.has(t)&&this.callbacks.add(t)}reset(){this.value=this.initialValue,this.changed()}read(){return this.readStats&&this.readStats.counter(),this.#n(),this.value}write(t,{force:e=!1}={}){if(n.length>0)throw new Error("write used inside a reactive callback");return this.writeStats&&this.writeStats.counter(),(this.value!==t||e)&&(this.value=t,this.changed()),this.value}changed(){const t=performance.now(),e=[];for(const t of this.callbacks)t.execute()===s&&e.push(t);for(const t of e)this.callbacks.delete(t),console.log("removed callback",t);this.changedStats&&this.changedStats.update(performance.now()-t)}toString(){return this.#n(),String(this.value)}}function u(t){return new l(t)}function h(e,n){t(e instanceof Element),t(n instanceof l),e instanceof HTMLInputElement?function(t,e){const n=()=>`${t.tagName}[type=${t.type}].bind(${e})`;if(t.matches('[type="checkbox"]')){const i=()=>e.write(t.checked),s=()=>t.checked=e.read();t.addEventListener("change",i);const r=new a(s);r.description=n,r.execute()}else{const i=()=>e.write(t.value),s=()=>t.value=e.read();t.addEventListener("input",i);const r=new a(s);r.description=n,r.execute()}}(e,n):e instanceof HTMLSelectElement&&function(t,e){const n=()=>`${t.tagName}.bind(${e})`;if(t.multiple);else{const i=()=>e.write(t.value),s=()=>t.value=e.read();t.addEventListener("change",i);const r=new a(s);r.description=n,r.execute()}}(e,n)}class p{constructor(e,n){t(e instanceof Element),t(Array.isArray(n)),this.element=e,this.initialChildCount=e.childNodes.length,this.childs=n.flat(1/0).map((t=>"function"==typeof t?new d(this,t):t)),this.#i()}#i(){for(const t of this.childs)t instanceof d?t.callback.execute():t&&t.container instanceof p?this.element.append(t.container.element):this.element.append(t);this.check()}#s(){return this.childs.reduce(((t,e)=>t+(e instanceof d?e.clen:1)),this.initialChildCount)}check(){const t=this.element.childNodes.length,e=this.#s();if(t!==e)throw new Error(`element desync current=${t} render=${e}`)}}class d{constructor(t,e){this.container=t,this.userCallback=e,this.firstInvocation=!0,this.clen=0,this.callback=new a((()=>this.#r())),this.callback.userCallback=e}#a(){let t=this.container.element.firstChild;if(null===t)return null;let e=this.container.initialChildCount;for(;e--;){if(null===t)throw new Error("child expected");t=t.nextSibling}e=0;for(const n of this.container.childs){if(n===this){for(;e--;){if(null===t)throw new Error("child expected");t=t.nextSibling}return t}e+="function"==typeof n?n.clen:1}throw new Error("function not found")}#r(){t(this instanceof d),this.firstInvocation||this.container.check();let e=this.clen;const n=[this.userCallback()].flat(1/0);this.clen=n.length;for(let t=0;t<n.length;t++)n[t]&&n[t].container instanceof p&&(n[t]=n[t].container.element);if(this.firstInvocation)this.firstInvocation=!1,n.length>0&&this.container.element.append(...n);else{let t=this.#a();if(null===t)this.container.element.append(...n);else{for(;e--;){if(null===t)throw new Error("child expected");const e=t;if(t=t.nextSibling,null===e.parentNode)throw new Error("parentNode is null");e.parentNode.removeChild(e)}if(n.length>0)if(null===t)this.container.element.append(...n);else{if(null===t.parentNode)throw new Error("parentNode is null");for(const e of n)e instanceof Node?t.parentNode.insertBefore(e,t):t.parentNode.insertBefore(document.createTextNode(e),t)}}}}}class f{constructor(e,n){t(e instanceof Element),t(Array.isArray(n)),this.container=new p(e,n)}get element(){return this.container.element}attr(e){t("object"==typeof e);for(const t in e)this.element.setAttribute(t,e[t]);return this}bind(t){return h(this.element,t),this}on(t,e){return this.element.addEventListener(t,e),this}onclick(t){return this.on("click",t),this}}function m(e,n){return t("string"==typeof e),t(e.length>0),function(...t){const i=document.createElement(e),s=new f(i,t);return n&&s.attr(n),s}}function b(t){return(...e)=>new f(t,e)}function g(t){if("string"==typeof t){if(t.startsWith("#")){const e=document.getElementById(t.slice(1));if(null===e)throw new Error("element not found");return b(e)}return m(t)}if(t instanceof Element)return b(t);throw new Error("invalid argument")}g.a=m("a"),g.abbr=m("abbr"),g.address=m("address"),g.area=m("area"),g.article=m("article"),g.aside=m("aside"),g.audio=m("audio"),g.b=m("b"),g.base=m("base"),g.bdi=m("bdi"),g.bdo=m("bdo"),g.blockquote=m("blockquote"),g.body=m("body"),g.br=m("br"),g.button=m("button"),g.canvas=m("canvas"),g.caption=m("caption"),g.cite=m("cite"),g.code=m("code"),g.col=m("col"),g.colgroup=m("colgroup"),g.data=m("data"),g.datalist=m("datalist"),g.dd=m("dd"),g.del=m("del"),g.details=m("details"),g.dfn=m("dfn"),g.dialog=m("dialog"),g.div=m("div"),g.dl=m("dl"),g.dt=m("dt"),g.em=m("em"),g.embed=m("embed"),g.fieldset=m("fieldset"),g.figcaption=m("figcaption"),g.figure=m("figure"),g.footer=m("footer"),g.form=m("form"),g.h1=m("h1"),g.h2=m("h2"),g.h3=m("h3"),g.h4=m("h4"),g.h5=m("h5"),g.h6=m("h6"),g.head=m("head"),g.header=m("header"),g.hgroup=m("hgroup"),g.hr=m("hr"),g.html=m("html"),g.i=m("i"),g.iframe=m("iframe"),g.img=m("img"),g.input=m("input"),g.ins=m("ins"),g.kbd=m("kbd"),g.label=m("label"),g.legend=m("legend"),g.li=m("li"),g.link=m("link"),g.main=m("main"),g.map=m("map"),g.mark=m("mark"),g.math=m("math"),g.menu=m("menu"),g.meta=m("meta"),g.meter=m("meter"),g.nav=m("nav"),g.noscript=m("noscript"),g.object=m("object"),g.ol=m("ol"),g.optgroup=m("optgroup"),g.option=m("option"),g.output=m("output"),g.p=m("p"),g.picture=m("picture"),g.pre=m("pre"),g.progress=m("progress"),g.q=m("q"),g.rp=m("rp"),g.rt=m("rt"),g.ruby=m("ruby"),g.s=m("s"),g.samp=m("samp"),g.script=m("script"),g.search=m("search"),g.section=m("section"),g.select=m("select"),g.slot=m("slot"),g.small=m("small"),g.source=m("source"),g.span=m("span"),g.strong=m("strong"),g.style=m("style"),g.sub=m("sub"),g.summary=m("summary"),g.sup=m("sup"),g.svg=m("svg"),g.table=m("table"),g.tbody=m("tbody"),g.td=m("td"),g.template=m("template"),g.textarea=m("textarea"),g.tfoot=m("tfoot"),g.th=m("th"),g.thead=m("thead"),g.time=m("time"),g.title=m("title"),g.tr=m("tr"),g.track=m("track"),g.u=m("u"),g.ul=m("ul"),g.var=m("var"),g.video=m("video"),g.wbr=m("wbr"),g.input_hidden=m("input",{type:"hidden"}),g.input_text=m("input",{type:"text"}),g.input_search=m("input",{type:"search"}),g.input_tel=m("input",{type:"tel"}),g.input_url=m("input",{type:"url"}),g.input_email=m("input",{type:"email"}),g.input_password=m("input",{type:"password"}),g.input_date=m("input",{type:"date"}),g.input_month=m("input",{type:"month"}),g.input_week=m("input",{type:"week"}),g.input_time=m("input",{type:"time"}),g.input_datetime_local=m("input",{type:"datetime-local"}),g.input_number=m("input",{type:"number"}),g.input_range=m("input",{type:"range"}),g.input_color=m("input",{type:"color"}),g.input_checkbox=m("input",{type:"checkbox"}),g.input_radio=m("input",{type:"radio"}),g.input_file=m("input",{type:"file"}),g.input_submit=m("input",{type:"submit"}),g.input_image=m("input",{type:"image"}),g.input_reset=m("input",{type:"reset"}),g.input_button=m("input",{type:"button"}),g.IF=function(t){return t instanceof l?(...e)=>()=>t.read()?e:[]:(...e)=>t?e:[]};export{o as newCallback,g as newTag,u as newValue};
