function t(t,e){if(!t)throw new Error(e??"assert fail")}const e=new class{#t=[];#e=0;constructor(){}push(e){t(e instanceof a),this.#e++,this.#t.push(e)}pop(){return t(this.#e-1>=0,"unbalanced stack"),this.#e--,this.#t.pop()}get length(){return this.#t.length}get current(){return this.#t[this.#t.length-1]}};class n{constructor(t){this.initialValue=t,this.value=t,this.callbacks=new Set,this.resetBound=this.reset.bind(this),i._enabled&&(this.stats_reads=new s,this.stats_writes=new s,this.stats_changes=new s,i.values.push(this))}#n(){const t=e.current;t&&!this.callbacks.has(t)&&this.callbacks.add(t)}reset(){this.value=this.initialValue,this.changed()}read(){return this.stats_reads&&this.stats_reads.counter(),this.#n(),this.value}write(t,{force:n=!1}={}){if(e.length>0)throw new Error("infinite loop");return this.stats_writes&&this.stats_writes.counter(),(this.value!==t||n)&&(this.value=t,this.changed()),this.value}changed(){const t=performance.now(),e=[];for(const t of this.callbacks)t.execute()===r&&e.push(t);for(const t of e)this.callbacks.delete(t),console.log("removed callback",t);this.stats_changes&&this.stats_changes.update(performance.now()-t)}toString(){return this.#n(),String(this.value)}}const i={_enabled:!0,callbacks:[],values:[],tags:{},addTag:function(t){void 0===i.tags[t]&&(i.tags[t]=new s),i.tags[t].counter()}};class s{constructor(){this.cnt=0,this.sum=0,this.vmin=null,this.vmax=null,this.avg=0}counter(){this.cnt++}update(t){this.cnt++,this.sum+=t,this.vmin=null===this.vmin?t:Math.min(t,this.vmin),this.vmax=null===this.vmax?t:Math.max(t,this.vmax),this.avg=this.cnt>0?this.sum/this.cnt:0}toString(){return`cnt=${this.cnt} sum=${this.sum} min=${this.vmin} max=${this.vmax} avg=${this.avg}`}}const r=Symbol("stop");class a{constructor(e){t(e instanceof Function),this.callback=e,this.description=null,this.userCallback=null,this.stopped=!1,i._enabled&&(this.stats_execute=new s,i.callbacks.push(this))}stop(){this.stopped=!0}execute(...t){const n=performance.now();if(this.stopped)return r;e.push(this);try{return this.callback(...t)}finally{e.pop(),this.stats_execute&&this.stats_execute.update(performance.now()-n)}}}class o{constructor(e,n){t(e instanceof l),t("function"==typeof n),this.re=e,this.fn=n,this.initialChildCount=e.element.childNodes.length,this.firstInvocation=!0,this.clen=0,this.callback=new a((()=>this.#i())),this.callback.userCallback=n}#s(){const t=this.re.element.childNodes.length,e=this.re.childs.reduce(((t,e)=>t+(e instanceof o?e.clen:1)),this.initialChildCount);if(t!==e)throw new Error(`desync ${t} vs ${e}`)}#r(){let t=this.re.element.firstChild;if(null===t)return null;let e=this.initialChildCount;for(;e--;){if(null===t)throw new Error("child expected");t=t.nextSibling}e=0;for(const n of this.re.childs){if(n===this){for(;e--;){if(null===t)throw new Error("child expected");t=t.nextSibling}return t}e+="function"==typeof n?n.clen:1}throw new Error("function not found")}#i(){t(this instanceof o),this.firstInvocation||this.#s();let e=this.clen;const n=[this.fn()].flat(1/0);this.clen=n.length;for(let t=0;t<n.length;t++)n[t]instanceof l&&(n[t]=n[t].element);if(this.firstInvocation)this.firstInvocation=!1,n.length>0&&this.re.element.append(...n);else{let t=this.#r();if(null===t)this.re.element.append(...n);else{for(;e--;){if(null===t)throw new Error("child expected");const e=t;if(t=t.nextSibling,null===e.parentNode)throw new Error("parentNode is null");e.parentNode.removeChild(e)}if(n.length>0)if(null===t)this.re.element.append(...n);else{if(null===t.parentNode)throw new Error("parentNode is null");for(const e of n)e instanceof Node?t.parentNode.insertBefore(e,t):t.parentNode.insertBefore(document.createTextNode(e),t)}}}}}function c(e,i){t(e instanceof Element),t(i instanceof n),e instanceof HTMLInputElement?function(t,e){const n=()=>`${t.tagName}[type=${t.type}].bind(${e})`;if(t.matches('[type="checkbox"]')){const i=()=>e.write(t.checked),s=()=>t.checked=e.read();t.addEventListener("change",i);const r=new a(s);r.description=n,r.execute()}else{const i=()=>e.write(t.value),s=()=>t.value=e.read();t.addEventListener("input",i);const r=new a(s);r.description=n,r.execute()}}(e,i):e instanceof HTMLSelectElement&&function(t,e){const n=()=>`${t.tagName}.bind(${e})`;if(t.multiple);else{const i=()=>e.write(t.value),s=()=>t.value=e.read();t.addEventListener("change",i);const r=new a(s);r.description=n,r.execute()}}(e,i)}class l{constructor(e,n){t(e instanceof Element),t(Array.isArray(n)),this.element=e,this.childs=n.flat(1/0),this.#a(),i._enabled&&i.addTag(this.element.tagName)}#a(){for(let t=0;t<this.childs.length;t++){const e=this.childs[t];"function"==typeof e&&(this.childs[t]=new o(this,e))}for(const t of this.childs)t instanceof o?t.callback.execute():t instanceof l?this.element.append(t.element):this.element.append(t)}attr(e){t("object"==typeof e);for(const t in e)this.element.setAttribute(t,e[t]);return this}bind(t){return c(this.element,t),this}on(t,e){return this.element.addEventListener(t,e),this}onclick(t){return this.on("click",t),this}}function u(t){return new n(t)}function h(t){return new a(t)}function p(e,n){return t("string"==typeof e),t(e.length>0),function(...t){const i=document.createElement(e),s=new l(i,t);return n&&s.attr(n),s}}function d(t){return(...e)=>new l(t,e)}const f=function(t){if("string"==typeof t){if(t.startsWith("#")){const e=document.getElementById(t.slice(1));if(null===e)throw new Error("element not found");return d(e)}return p(t)}if(t instanceof Element)return d(t);throw new Error("invalid argument")};f.a=p("a"),f.abbr=p("abbr"),f.address=p("address"),f.area=p("area"),f.article=p("article"),f.aside=p("aside"),f.audio=p("audio"),f.b=p("b"),f.base=p("base"),f.bdi=p("bdi"),f.bdo=p("bdo"),f.blockquote=p("blockquote"),f.body=p("body"),f.br=p("br"),f.button=p("button"),f.canvas=p("canvas"),f.caption=p("caption"),f.cite=p("cite"),f.code=p("code"),f.col=p("col"),f.colgroup=p("colgroup"),f.data=p("data"),f.datalist=p("datalist"),f.dd=p("dd"),f.del=p("del"),f.details=p("details"),f.dfn=p("dfn"),f.dialog=p("dialog"),f.div=p("div"),f.dl=p("dl"),f.dt=p("dt"),f.em=p("em"),f.embed=p("embed"),f.fieldset=p("fieldset"),f.figcaption=p("figcaption"),f.figure=p("figure"),f.footer=p("footer"),f.form=p("form"),f.h1=p("h1"),f.h2=p("h2"),f.h3=p("h3"),f.h4=p("h4"),f.h5=p("h5"),f.h6=p("h6"),f.head=p("head"),f.header=p("header"),f.hgroup=p("hgroup"),f.hr=p("hr"),f.html=p("html"),f.i=p("i"),f.iframe=p("iframe"),f.img=p("img"),f.input=p("input"),f.ins=p("ins"),f.kbd=p("kbd"),f.label=p("label"),f.legend=p("legend"),f.li=p("li"),f.link=p("link"),f.main=p("main"),f.map=p("map"),f.mark=p("mark"),f.math=p("math"),f.menu=p("menu"),f.meta=p("meta"),f.meter=p("meter"),f.nav=p("nav"),f.noscript=p("noscript"),f.object=p("object"),f.ol=p("ol"),f.optgroup=p("optgroup"),f.option=p("option"),f.output=p("output"),f.p=p("p"),f.picture=p("picture"),f.pre=p("pre"),f.progress=p("progress"),f.q=p("q"),f.rp=p("rp"),f.rt=p("rt"),f.ruby=p("ruby"),f.s=p("s"),f.samp=p("samp"),f.script=p("script"),f.search=p("search"),f.section=p("section"),f.select=p("select"),f.slot=p("slot"),f.small=p("small"),f.source=p("source"),f.span=p("span"),f.strong=p("strong"),f.style=p("style"),f.sub=p("sub"),f.summary=p("summary"),f.sup=p("sup"),f.svg=p("svg"),f.table=p("table"),f.tbody=p("tbody"),f.td=p("td"),f.template=p("template"),f.textarea=p("textarea"),f.tfoot=p("tfoot"),f.th=p("th"),f.thead=p("thead"),f.time=p("time"),f.title=p("title"),f.tr=p("tr"),f.track=p("track"),f.u=p("u"),f.ul=p("ul"),f.var=p("var"),f.video=p("video"),f.wbr=p("wbr"),f.input_hidden=p("input",{type:"hidden"}),f.input_text=p("input",{type:"text"}),f.input_search=p("input",{type:"search"}),f.input_tel=p("input",{type:"tel"}),f.input_url=p("input",{type:"url"}),f.input_email=p("input",{type:"email"}),f.input_password=p("input",{type:"password"}),f.input_date=p("input",{type:"date"}),f.input_month=p("input",{type:"month"}),f.input_week=p("input",{type:"week"}),f.input_time=p("input",{type:"time"}),f.input_datetime_local=p("input",{type:"datetime-local"}),f.input_number=p("input",{type:"number"}),f.input_range=p("input",{type:"range"}),f.input_color=p("input",{type:"color"}),f.input_checkbox=p("input",{type:"checkbox"}),f.input_radio=p("input",{type:"radio"}),f.input_file=p("input",{type:"file"}),f.input_submit=p("input",{type:"submit"}),f.input_image=p("input",{type:"image"}),f.input_reset=p("input",{type:"reset"}),f.input_button=p("input",{type:"button"}),f.IF=function(e){return t(e instanceof n),function(...t){return()=>e.read()?t:[]}},f.IF_static=function(t){return(...e)=>t?e:[]};export{f as TAG,h as newCallback,u as newValue};
