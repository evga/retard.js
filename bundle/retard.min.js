function t(t,e){if(!t)throw new Error(e??"assert fail")}class e{constructor(){this.cnt=0,this.sum=0,this.vmin=null,this.vmax=null,this.avg=0}counter(){this.cnt++}update(t){this.cnt++,this.sum+=t,this.vmin=null===this.vmin?t:Math.min(t,this.vmin),this.vmax=null===this.vmax?t:Math.max(t,this.vmax),this.avg=this.cnt>0?this.sum/this.cnt:0}}const n=new class{#t=[];constructor(){}push(t){this.#t.push(t)}pop(){if(0===this.#t.length)throw new Error("unbalanced stack");return this.#t.pop()}get length(){return this.#t.length}get current(){return this.#t[this.#t.length-1]}};var i=!1,s=!0;let r=1;const o=Symbol("stop");class a{#e=r++;desc;constructor(n){t(n instanceof Function),this.fn=n,i&&(this.executeStats=new e),s&&console.debug(`NEW RC#${this.#e} = ${n}`)}execute(...t){if("function"!=typeof this.fn)return o;const e=performance.now();s&&console.debug(`EXECUTE ${this}`),n.push(this);try{return this.fn(...t)}finally{n.pop(),this.executeStats&&this.executeStats.update(performance.now()-e)}}toString(){return`CB#${this.#e} ${this.desc??this.fn}`}}function c(t){return new a(t)}let l=1;const u=[];class h{#e=l++;constructor(t){this.initialValue=t,this.value=t,this.callbacks=new Set,this.resetBound=this.reset.bind(this),i&&(this.readStats=new e,this.writeStats=new e,this.changedStats=new e,u.push(this)),s&&console.debug(`NEW RV#${this.#e} = ${this.value}`)}capture(){n.current&&(this.callbacks.add(n.current),s&&console.debug(`CAPTURE RV#${this.#e} <<< ${n.current}`))}reset(){this.value=this.initialValue,this.changed()}read(){return this.readStats&&this.readStats.counter(),this.capture(),this.value}write(t,{force:e=!1}={}){if(n.length>0)throw new Error("write used inside a reactive callback");return this.writeStats&&this.writeStats.counter(),(this.value!==t||e)&&(this.value=t,this.changed()),this.value}changed(){s&&console.debug(`CHANGED ${this.value}`);const t=performance.now(),e=[];for(const t of this.callbacks)t.execute()===o&&e.push(t);for(const t of e)this.callbacks.delete(t),s&&console.debug(`LETGO ${t}`);this.changedStats&&this.changedStats.update(performance.now()-t)}map(t){if(this.capture(),Array.isArray(this.value))return this.value.map(t);throw new Error("no array")}toString(){return this.capture(),String(this.value)}}function d(t){return new h(t)}let p=[],f=[];function m(t,e,n,i){t.addEventListener(e,n,i),p.push([t,e,n,i])}function b(e,n){t(n instanceof Function);const i=new a(n);return f.push([e,i]),i}function g(t){for(const e of p)e[0]===t&&(s&&console.debug(`DETACH ${e}`),e[0].removeEventListener(e[1],e[2],e[3]));for(const e of f)e[0]===t&&(s&&console.debug(`DETACH ${e}`),e[1].callback=null,e[1].description=null);p=p.filter((e=>e[0]!==t)),f=f.filter((e=>e[0]!==t))}function y(e,n){t(e instanceof Element),t(n instanceof h),e instanceof HTMLInputElement?function(t,e){const n=`${t.tagName}[type=${t.type}].bind(${e.value})`;if(t.matches('[type="checkbox"]')){const i=()=>t.checked=e.read();m(t,"change",(()=>e.write(t.checked)));const s=b(t,i);s.desc=n,s.execute()}else{const i=()=>t.value=e.read();m(t,"input",(()=>e.write(t.value)));const s=b(t,i);s.desc=n,s.execute()}}(e,n):e instanceof HTMLSelectElement&&function(t,e){const n=`${t.tagName}.bind(${e.value})`;if(t.multiple);else{const i=()=>t.value=e.read();m(t,"change",(()=>e.write(t.value)));const s=b(t,i);s.desc=n,s.execute()}}(e,n)}class w{constructor(e,n){t(e instanceof Element),t(Array.isArray(n)),this.element=e,this.initialChildCount=e.childNodes.length,this.childs=n.flat(1/0).map((t=>"function"==typeof t?new v(this,t):t)),this.#n()}#n(){for(const t of this.childs)t instanceof v?t.callback.execute():t&&t.container instanceof w?this.element.append(t.container.element):this.element.append(t);this.check()}#i(){return this.childs.reduce(((t,e)=>t+(e instanceof v?e.clen:1)),this.initialChildCount)}check(){const t=this.element.childNodes.length,e=this.#i();if(t!==e)throw new Error(`element desync current=${t} render=${e}`)}}class v{constructor(t,e){this.container=t,this.userCallback=e,this.firstInvocation=!0,this.clen=0,this.callback=b(t.element,(()=>this.#s())),this.callback.desc=`ReactiveChild(${e})`}#r(){let t=this.container.element.firstChild;if(null===t)return null;let e=this.container.initialChildCount;for(;e--;){if(null===t)throw new Error("child expected");t=t.nextSibling}e=0;for(const n of this.container.childs){if(n===this){for(;e--;){if(null===t)throw new Error("child expected");t=t.nextSibling}return t}e+=n instanceof v?n.clen:1}throw new Error("function not found")}#s(){this.firstInvocation||this.container.check();let t=this.clen;const e=[this.userCallback()].flat(1/0);this.clen=e.length;for(let t=0;t<e.length;t++)e[t]&&e[t].container instanceof w&&(e[t]=e[t].container.element);if(this.firstInvocation)this.firstInvocation=!1,e.length>0&&this.container.element.append(...e);else{let n=this.#r();if(null===n)this.container.element.append(...e);else{for(;t--;){if(null===n)throw new Error("child expected");const t=n;if(n=n.nextSibling,null===t.parentNode)throw new Error("parentNode is null");t.parentNode.removeChild(t),g(t)}if(e.length>0)if(null===n)this.container.element.append(...e);else{if(null===n.parentNode)throw new Error("parentNode is null");for(const t of e)t instanceof Node?n.parentNode.insertBefore(t,n):n.parentNode.insertBefore(document.createTextNode(t),n)}}}}}const k=new RegExp("^<(\\w+)>$"),x=new RegExp("^(\\w+)\\[(\\w+)=(\\w+)]$");class ${constructor(e,n){t(e instanceof Element),t(Array.isArray(n)),this.container=new w(e,n)}get element(){return this.container.element}attr(e){t("object"==typeof e);for(const t in e){const n=e[t];if(n instanceof h){const e=this,i=b(this.element,(()=>e.element.setAttribute(t,n.read())));i.desc=`Reactive attribute ${this.element.tagName}.${t} = ${n}`,i.execute()}else this.element.setAttribute(t,n)}return this}prop(e){t("object"==typeof e);for(const t in e){const n=e[t];if(n instanceof h){const e=this,i=b(this.element,(()=>e.element[t]=n.read()));i.desc=`Reactive prop ${this.element.tagName}.${t} = ${n}`,i.execute()}else this.element[t]=n}return this}bind(t){return y(this.element,t),this}on(t,e,n){if("string"==typeof t&&"function"==typeof e){const i=k.exec(t);i&&(t=`keydown[key=${i[1]}]`);const s=x.exec(t);if(s){const t=s[1],i=s[2],r=s[3];m(this.element,t,(function(t){t[i]&&t[i]==r&&e.call(this,t)}),n)}else m(this.element,t,e,n)}else m(this.element,t,e,n);return this}}function E(e,n){return t("string"==typeof e),t(e.length>0),function(...t){const i=document.createElement(e),s=new $(i,t);return n&&s.attr(n),s}}function S(t){return(...e)=>new $(t,e)}function C(t){if("string"==typeof t){if(t.startsWith("#")){const e=document.getElementById(t.slice(1));if(null===e)throw new Error("element not found");return S(e)}return E(t)}if(t instanceof Element)return S(t);throw new Error("invalid argument")}function _(t,e){const n=document.createElement(t);if("object"==typeof e)for(const t in e)n.setAttribute(t,e[t]);return function(...t){return n.append(...t.flat(1/0)),n}}function N(t){return _("tr")(_("td",{colspan:"6",style:"background-color: #000; color: #fff"})(t??""))}function A(t){return _("tr",{style:"border-bottom: 1px solid #666"})(_("td",{colspan:"6",style:"background-color: #ccc"})(t??""))}function R(t,n,i,s,r,o){if(n instanceof e){const t=n;n=t.cnt,i=t.sum,s=t.vmin,r=t.vmax,o=t.avg.toFixed(1)}const a="text-align: center; background-color: #6666cc";return _("tr")(_("td",{style:"background-color: #999999; color: #000"})(t??""),_("td",{style:"text-align: center; background-color: #cccc66"})(n??""),_("td",{style:a})(i??""),_("td",{style:a})(s??""),_("td",{style:a})(r??""),_("td",{style:a})(o??""))}function T({tags:t=!0,details:e=!1}={}){return _("table",{style:"border-collapse: collapse; font-family: monospace; font-size: 12px; width: 100%"})(R("metric","cnt","sum","min","max","avg"),N("Registry:Events"),...p.map((t=>[A(`${t[0].tagName}.on${t[1]} --- ${t[2]}`)])),N("Registry:Callbacks"),...f.map((t=>[A(`${t[0].tagName} >>> ${t[1]}`),R("execute",t.executeStats)])),N(`Values: ${u.length}`),...u.map((t=>[A(`[${typeof t.value}] ${t.value}`),e?R("callbacks",t.callbacks.size):"",e?R("reads",t.readStats):"",e?R("writes",t.writeStats):"",e?R("changes",t.changedStats):""])))}C.a=E("a"),C.abbr=E("abbr"),C.address=E("address"),C.area=E("area"),C.article=E("article"),C.aside=E("aside"),C.audio=E("audio"),C.b=E("b"),C.base=E("base"),C.bdi=E("bdi"),C.bdo=E("bdo"),C.blockquote=E("blockquote"),C.body=E("body"),C.br=E("br"),C.button=E("button"),C.canvas=E("canvas"),C.caption=E("caption"),C.cite=E("cite"),C.code=E("code"),C.col=E("col"),C.colgroup=E("colgroup"),C.data=E("data"),C.datalist=E("datalist"),C.dd=E("dd"),C.del=E("del"),C.details=E("details"),C.dfn=E("dfn"),C.dialog=E("dialog"),C.div=E("div"),C.dl=E("dl"),C.dt=E("dt"),C.em=E("em"),C.embed=E("embed"),C.fieldset=E("fieldset"),C.figcaption=E("figcaption"),C.figure=E("figure"),C.footer=E("footer"),C.form=E("form"),C.h1=E("h1"),C.h2=E("h2"),C.h3=E("h3"),C.h4=E("h4"),C.h5=E("h5"),C.h6=E("h6"),C.head=E("head"),C.header=E("header"),C.hgroup=E("hgroup"),C.hr=E("hr"),C.html=E("html"),C.i=E("i"),C.iframe=E("iframe"),C.img=E("img"),C.input=E("input"),C.ins=E("ins"),C.kbd=E("kbd"),C.label=E("label"),C.legend=E("legend"),C.li=E("li"),C.link=E("link"),C.main=E("main"),C.map=E("map"),C.mark=E("mark"),C.math=E("math"),C.menu=E("menu"),C.meta=E("meta"),C.meter=E("meter"),C.nav=E("nav"),C.noscript=E("noscript"),C.object=E("object"),C.ol=E("ol"),C.optgroup=E("optgroup"),C.option=E("option"),C.output=E("output"),C.p=E("p"),C.picture=E("picture"),C.pre=E("pre"),C.progress=E("progress"),C.q=E("q"),C.rp=E("rp"),C.rt=E("rt"),C.ruby=E("ruby"),C.s=E("s"),C.samp=E("samp"),C.script=E("script"),C.search=E("search"),C.section=E("section"),C.select=E("select"),C.slot=E("slot"),C.small=E("small"),C.source=E("source"),C.span=E("span"),C.strong=E("strong"),C.style=E("style"),C.sub=E("sub"),C.summary=E("summary"),C.sup=E("sup"),C.svg=E("svg"),C.table=E("table"),C.tbody=E("tbody"),C.td=E("td"),C.template=E("template"),C.textarea=E("textarea"),C.tfoot=E("tfoot"),C.th=E("th"),C.thead=E("thead"),C.time=E("time"),C.title=E("title"),C.tr=E("tr"),C.track=E("track"),C.u=E("u"),C.ul=E("ul"),C.var=E("var"),C.video=E("video"),C.wbr=E("wbr"),C.input_hidden=E("input",{type:"hidden"}),C.input_text=E("input",{type:"text"}),C.input_search=E("input",{type:"search"}),C.input_tel=E("input",{type:"tel"}),C.input_url=E("input",{type:"url"}),C.input_email=E("input",{type:"email"}),C.input_password=E("input",{type:"password"}),C.input_date=E("input",{type:"date"}),C.input_month=E("input",{type:"month"}),C.input_week=E("input",{type:"week"}),C.input_time=E("input",{type:"time"}),C.input_datetime_local=E("input",{type:"datetime-local"}),C.input_number=E("input",{type:"number"}),C.input_range=E("input",{type:"range"}),C.input_color=E("input",{type:"color"}),C.input_checkbox=E("input",{type:"checkbox"}),C.input_radio=E("input",{type:"radio"}),C.input_file=E("input",{type:"file"}),C.input_submit=E("input",{type:"submit"}),C.input_image=E("input",{type:"image"}),C.input_reset=E("input",{type:"reset"}),C.input_button=E("input",{type:"button"}),C.IF=function(t){return t instanceof h?(...e)=>()=>t.read()?e:[]:(...e)=>t?e:[]};export{c as newCallback,C as newTag,d as newValue,T as report};
