function t(t,e){if(!t)throw new Error(e??"assert fail")}class e{constructor(){this.cnt=0,this.sum=0,this.vmin=null,this.vmax=null,this.avg=0}counter(){this.cnt++}update(t){this.cnt++,this.sum+=t,this.vmin=null===this.vmin?t:Math.min(t,this.vmin),this.vmax=null===this.vmax?t:Math.max(t,this.vmax),this.avg=this.cnt>0?this.sum/this.cnt:0}}const n=new class{#t=[];constructor(){}push(t){this.#t.push(t)}pop(){if(0===this.#t.length)throw new Error("unbalanced stack");return this.#t.pop()}get length(){return this.#t.length}get current(){return this.#t[this.#t.length-1]}};var i=!0;const s=Symbol("stop"),r=[];class o{#e=!1;description;userCallback;constructor(n){t(n instanceof Function),this.callback=n,i&&(this.executeStats=new e,r.push(this))}stop(){this.#e=!0}execute(...t){const e=performance.now();if(this.#e)return s;n.push(this);try{return this.callback(...t)}finally{n.pop(),this.executeStats&&this.executeStats.update(performance.now()-e)}}}function a(t){return new o(t)}const c=[];class l{constructor(t){this.initialValue=t,this.value=t,this.callbacks=new Set,this.resetBound=this.reset.bind(this),i&&(this.readStats=new e,this.writeStats=new e,this.changedStats=new e,c.push(this))}capture(){n.current&&this.callbacks.add(n.current)}reset(){this.value=this.initialValue,this.changed()}read(){return this.readStats&&this.readStats.counter(),this.capture(),this.value}write(t,{force:e=!1}={}){if(n.length>0)throw new Error("write used inside a reactive callback");return this.writeStats&&this.writeStats.counter(),(this.value!==t||e)&&(this.value=t,this.changed()),this.value}changed(){const t=performance.now(),e=[];for(const t of this.callbacks)t.execute()===s&&e.push(t);for(const t of e)this.callbacks.delete(t);this.changedStats&&this.changedStats.update(performance.now()-t)}toString(){return this.capture(),String(this.value)}}function u(t){return new l(t)}function h(e,n){t(e instanceof Element),t(n instanceof l),e instanceof HTMLInputElement?function(t,e){const n=()=>`${t.tagName}[type=${t.type}].bind(${e})`;if(t.matches('[type="checkbox"]')){const i=()=>e.write(t.checked),s=()=>t.checked=e.read();t.addEventListener("change",i);const r=new o(s);r.description=n,r.execute()}else{const i=()=>e.write(t.value),s=()=>t.value=e.read();t.addEventListener("input",i);const r=new o(s);r.description=n,r.execute()}}(e,n):e instanceof HTMLSelectElement&&function(t,e){const n=()=>`${t.tagName}.bind(${e})`;if(t.multiple);else{const i=()=>e.write(t.value),s=()=>t.value=e.read();t.addEventListener("change",i);const r=new o(s);r.description=n,r.execute()}}(e,n)}class p{constructor(e,n){t(e instanceof Element),t(Array.isArray(n)),this.element=e,this.initialChildCount=e.childNodes.length,this.childs=n.flat(1/0).map((t=>"function"==typeof t?new d(this,t):t)),this.#n()}#n(){for(const t of this.childs)t instanceof d?t.callback.execute():t&&t.container instanceof p?this.element.append(t.container.element):this.element.append(t);this.check()}#i(){return this.childs.reduce(((t,e)=>t+(e instanceof d?e.clen:1)),this.initialChildCount)}check(){const t=this.element.childNodes.length,e=this.#i();if(t!==e)throw new Error(`element desync current=${t} render=${e}`)}}class d{constructor(t,e){this.container=t,this.userCallback=e,this.firstInvocation=!0,this.clen=0,this.callback=new o((()=>this.#s())),this.callback.userCallback=e}#r(){let t=this.container.element.firstChild;if(null===t)return null;let e=this.container.initialChildCount;for(;e--;){if(null===t)throw new Error("child expected");t=t.nextSibling}e=0;for(const n of this.container.childs){if(n===this){for(;e--;){if(null===t)throw new Error("child expected");t=t.nextSibling}return t}e+="function"==typeof n?n.clen:1}throw new Error("function not found")}#s(){t(this instanceof d),this.firstInvocation||this.container.check();let e=this.clen;const n=[this.userCallback()].flat(1/0);this.clen=n.length;for(let t=0;t<n.length;t++)n[t]&&n[t].container instanceof p&&(n[t]=n[t].container.element);if(this.firstInvocation)this.firstInvocation=!1,n.length>0&&this.container.element.append(...n);else{let t=this.#r();if(null===t)this.container.element.append(...n);else{for(;e--;){if(null===t)throw new Error("child expected");const e=t;if(t=t.nextSibling,null===e.parentNode)throw new Error("parentNode is null");e.parentNode.removeChild(e)}if(n.length>0)if(null===t)this.container.element.append(...n);else{if(null===t.parentNode)throw new Error("parentNode is null");for(const e of n)e instanceof Node?t.parentNode.insertBefore(e,t):t.parentNode.insertBefore(document.createTextNode(e),t)}}}}}const f=new RegExp("^<(\\w+)>$"),m=new RegExp("^(\\w+)\\[(\\w+)=(\\w+)]$");class b{constructor(e,n){t(e instanceof Element),t(Array.isArray(n)),this.container=new p(e,n)}get element(){return this.container.element}attr(e){t("object"==typeof e);for(const t in e){const n=e[t];if(n instanceof l){const e=this,i=new o((()=>e.element.setAttribute(t,n.read())));i.description=`Reactive attribute ${this.element.tagName}.${t} = ${n}`,i.execute()}else this.element.setAttribute(t,n)}return this}bind(t){return h(this.element,t),this}on(t,e,n){if("string"==typeof t&&"function"==typeof e){const i=f.exec(t);i&&(t=`keydown[key=${i[1]}]`);const s=m.exec(t);if(s){const t=s[1],i=s[2],r=s[3];this.element.addEventListener(t,(function(t){t[i]&&t[i]==r&&e.call(this,t)}),n)}else this.element.addEventListener(t,e,n)}else this.element.addEventListener(t,e,n);return this}}function g(e,n){return t("string"==typeof e),t(e.length>0),function(...t){const i=document.createElement(e),s=new b(i,t);return n&&s.attr(n),s}}function w(t){return(...e)=>new b(t,e)}function y(t){if("string"==typeof t){if(t.startsWith("#")){const e=document.getElementById(t.slice(1));if(null===e)throw new Error("element not found");return w(e)}return g(t)}if(t instanceof Element)return w(t);throw new Error("invalid argument")}function k(t,e){const n=document.createElement(t);if("object"==typeof e)for(const t in e)n.setAttribute(t,e[t]);return function(...t){return n.append(...t.flat(1/0)),n}}function v(t){return k("tr")(k("td",{colspan:"6",style:"background-color: #000; color: #fff"})(t??""))}function x(t){return k("tr",{style:"border-bottom: 1px solid #666"})(k("td",{colspan:"6",style:"background-color: #ccc"})(t??""))}function E(t,n,i,s,r,o){if(n instanceof e){const t=n;n=t.cnt,i=t.sum,s=t.vmin,r=t.vmax,o=t.avg.toFixed(1)}const a="text-align: center; background-color: #6666cc";return k("tr")(k("td",{style:"background-color: #999999; color: #000"})(t??""),k("td",{style:"text-align: center; background-color: #cccc66"})(n??""),k("td",{style:a})(i??""),k("td",{style:a})(s??""),k("td",{style:a})(r??""),k("td",{style:a})(o??""))}function S(t){return t.description?"function"==typeof t.description?t.description():t.description:t.userCallback?String(t.userCallback):String(t.callback)}function _({tags:t=!0,details:e=!1}={}){return k("table",{style:"border-collapse: collapse; font-size: 12px; width: 100%"})(E("metric","cnt","sum","min","max","avg"),t?v("Tags"):"",v(`Values: ${c.length}`),...c.map((t=>[x(`[${typeof t.value}] ${t.value}`),e?E("callbacks",t.callbacks.size):"",e?E("reads",t.readStats):"",e?E("writes",t.writeStats):"",e?E("changes",t.changedStats):""])),v(`Callbacks: ${r.length}`),...r.map((t=>[x(S(t)),e?E("execute",t.executeStats):""])))}y.a=g("a"),y.abbr=g("abbr"),y.address=g("address"),y.area=g("area"),y.article=g("article"),y.aside=g("aside"),y.audio=g("audio"),y.b=g("b"),y.base=g("base"),y.bdi=g("bdi"),y.bdo=g("bdo"),y.blockquote=g("blockquote"),y.body=g("body"),y.br=g("br"),y.button=g("button"),y.canvas=g("canvas"),y.caption=g("caption"),y.cite=g("cite"),y.code=g("code"),y.col=g("col"),y.colgroup=g("colgroup"),y.data=g("data"),y.datalist=g("datalist"),y.dd=g("dd"),y.del=g("del"),y.details=g("details"),y.dfn=g("dfn"),y.dialog=g("dialog"),y.div=g("div"),y.dl=g("dl"),y.dt=g("dt"),y.em=g("em"),y.embed=g("embed"),y.fieldset=g("fieldset"),y.figcaption=g("figcaption"),y.figure=g("figure"),y.footer=g("footer"),y.form=g("form"),y.h1=g("h1"),y.h2=g("h2"),y.h3=g("h3"),y.h4=g("h4"),y.h5=g("h5"),y.h6=g("h6"),y.head=g("head"),y.header=g("header"),y.hgroup=g("hgroup"),y.hr=g("hr"),y.html=g("html"),y.i=g("i"),y.iframe=g("iframe"),y.img=g("img"),y.input=g("input"),y.ins=g("ins"),y.kbd=g("kbd"),y.label=g("label"),y.legend=g("legend"),y.li=g("li"),y.link=g("link"),y.main=g("main"),y.map=g("map"),y.mark=g("mark"),y.math=g("math"),y.menu=g("menu"),y.meta=g("meta"),y.meter=g("meter"),y.nav=g("nav"),y.noscript=g("noscript"),y.object=g("object"),y.ol=g("ol"),y.optgroup=g("optgroup"),y.option=g("option"),y.output=g("output"),y.p=g("p"),y.picture=g("picture"),y.pre=g("pre"),y.progress=g("progress"),y.q=g("q"),y.rp=g("rp"),y.rt=g("rt"),y.ruby=g("ruby"),y.s=g("s"),y.samp=g("samp"),y.script=g("script"),y.search=g("search"),y.section=g("section"),y.select=g("select"),y.slot=g("slot"),y.small=g("small"),y.source=g("source"),y.span=g("span"),y.strong=g("strong"),y.style=g("style"),y.sub=g("sub"),y.summary=g("summary"),y.sup=g("sup"),y.svg=g("svg"),y.table=g("table"),y.tbody=g("tbody"),y.td=g("td"),y.template=g("template"),y.textarea=g("textarea"),y.tfoot=g("tfoot"),y.th=g("th"),y.thead=g("thead"),y.time=g("time"),y.title=g("title"),y.tr=g("tr"),y.track=g("track"),y.u=g("u"),y.ul=g("ul"),y.var=g("var"),y.video=g("video"),y.wbr=g("wbr"),y.input_hidden=g("input",{type:"hidden"}),y.input_text=g("input",{type:"text"}),y.input_search=g("input",{type:"search"}),y.input_tel=g("input",{type:"tel"}),y.input_url=g("input",{type:"url"}),y.input_email=g("input",{type:"email"}),y.input_password=g("input",{type:"password"}),y.input_date=g("input",{type:"date"}),y.input_month=g("input",{type:"month"}),y.input_week=g("input",{type:"week"}),y.input_time=g("input",{type:"time"}),y.input_datetime_local=g("input",{type:"datetime-local"}),y.input_number=g("input",{type:"number"}),y.input_range=g("input",{type:"range"}),y.input_color=g("input",{type:"color"}),y.input_checkbox=g("input",{type:"checkbox"}),y.input_radio=g("input",{type:"radio"}),y.input_file=g("input",{type:"file"}),y.input_submit=g("input",{type:"submit"}),y.input_image=g("input",{type:"image"}),y.input_reset=g("input",{type:"reset"}),y.input_button=g("input",{type:"button"}),y.IF=function(t){return t instanceof l?(...e)=>()=>t.read()?e:[]:(...e)=>t?e:[]};export{a as newCallback,y as newTag,u as newValue,_ as report};
