function t(t,e){if(!t)throw new Error(e??"assert fail")}class e{constructor(){this.cnt=0,this.sum=0,this.vmin=null,this.vmax=null,this.avg=0}counter(){this.cnt++}update(t){this.cnt++,this.sum+=t,this.vmin=null===this.vmin?t:Math.min(t,this.vmin),this.vmax=null===this.vmax?t:Math.max(t,this.vmax),this.avg=this.cnt>0?this.sum/this.cnt:0}}const n=new class{#t=[];constructor(){}push(t){this.#t.push(t)}pop(){if(0===this.#t.length)throw new Error("unbalanced stack");return this.#t.pop()}get length(){return this.#t.length}get current(){return this.#t[this.#t.length-1]}};var i=!1;const s=Symbol("stop"),r=[];class o{stopped=!1;description;constructor(n){t(n instanceof Function),this.callback=n,i&&(this.executeStats=new e,r.push(this))}execute(...t){if(this.stopped)return s;const e=performance.now();n.push(this);try{return this.callback(...t)}finally{n.pop(),this.executeStats&&this.executeStats.update(performance.now()-e)}}}function a(t){return new o(t)}const c=[];class l{constructor(t){this.initialValue=t,this.value=t,this.callbacks=new Set,this.resetBound=this.reset.bind(this),i&&(this.readStats=new e,this.writeStats=new e,this.changedStats=new e,c.push(this))}capture(){n.current&&this.callbacks.add(n.current)}reset(){this.value=this.initialValue,this.changed()}read(){return this.readStats&&this.readStats.counter(),this.capture(),this.value}write(t,{force:e=!1}={}){if(n.length>0)throw new Error("write used inside a reactive callback");return this.writeStats&&this.writeStats.counter(),(this.value!==t||e)&&(this.value=t,this.changed()),this.value}changed(){const t=performance.now(),e=[];for(const t of this.callbacks)t.execute()===s&&e.push(t);for(const t of e)this.callbacks.delete(t);this.changedStats&&this.changedStats.update(performance.now()-t)}map(t){if(this.capture(),Array.isArray(this.value))return this.value.map(t);throw new Error("no array")}toString(){return this.capture(),String(this.value)}}function u(t){return new l(t)}let h=[],p=[];function d(t,e,n,i){t.addEventListener(e,n,i),h.push([t,e,n,i])}function f(e,n){t(n instanceof Function);const i=new o(n);return p.push([e,i]),i}function m(t){for(const e of h)e[0]===t&&e[0].removeEventListener(e[1],e[2],e[3]);for(const e of p)e[0]===t&&(e[1].stopped=!0,e[1].callback=null,e[1].description=null);h=h.filter((e=>e[0]!==t)),p=p.filter((e=>e[0]!==t))}function b(e,n){t(e instanceof Element),t(n instanceof l),e instanceof HTMLInputElement?function(t,e){const n=`${t.tagName}[type=${t.type}].bind(${e.value})`;if(t.matches('[type="checkbox"]')){const i=()=>t.checked=e.read();d(t,"change",(()=>e.write(t.checked)));const s=f(t,i);s.description=n,s.execute()}else{const i=()=>t.value=e.read();d(t,"input",(()=>e.write(t.value)));const s=f(t,i);s.description=n,s.execute()}}(e,n):e instanceof HTMLSelectElement&&function(t,e){const n=`${t.tagName}.bind(${e.value})`;if(t.multiple);else{const i=()=>t.value=e.read();d(t,"change",(()=>e.write(t.value)));const s=f(t,i);s.description=n,s.execute()}}(e,n)}class g{constructor(e,n){t(e instanceof Element),t(Array.isArray(n)),this.element=e,this.initialChildCount=e.childNodes.length,this.childs=n.flat(1/0).map((t=>"function"==typeof t?new y(this,t):t)),this.#e()}#e(){for(const t of this.childs)t instanceof y?t.callback.execute():t&&t.container instanceof g?this.element.append(t.container.element):this.element.append(t);this.check()}#n(){return this.childs.reduce(((t,e)=>t+(e instanceof y?e.clen:1)),this.initialChildCount)}check(){const t=this.element.childNodes.length,e=this.#n();if(t!==e)throw new Error(`element desync current=${t} render=${e}`)}}class y{constructor(t,e){this.container=t,this.userCallback=e,this.firstInvocation=!0,this.clen=0,this.callback=f(t.element,(()=>this.#i())),this.callback.description=`ReactiveChild(${e})`}#s(){let t=this.container.element.firstChild;if(null===t)return null;let e=this.container.initialChildCount;for(;e--;){if(null===t)throw new Error("child expected");t=t.nextSibling}e=0;for(const n of this.container.childs){if(n===this){for(;e--;){if(null===t)throw new Error("child expected");t=t.nextSibling}return t}e+=n instanceof y?n.clen:1}throw new Error("function not found")}#i(){t(this instanceof y),this.firstInvocation||this.container.check();let e=this.clen;const n=[this.userCallback()].flat(1/0);this.clen=n.length;for(let t=0;t<n.length;t++)n[t]&&n[t].container instanceof g&&(n[t]=n[t].container.element);if(this.firstInvocation)this.firstInvocation=!1,n.length>0&&this.container.element.append(...n);else{let t=this.#s();if(null===t)this.container.element.append(...n);else{for(;e--;){if(null===t)throw new Error("child expected");const e=t;if(t=t.nextSibling,null===e.parentNode)throw new Error("parentNode is null");e.parentNode.removeChild(e),m(e)}if(n.length>0)if(null===t)this.container.element.append(...n);else{if(null===t.parentNode)throw new Error("parentNode is null");for(const e of n)e instanceof Node?t.parentNode.insertBefore(e,t):t.parentNode.insertBefore(document.createTextNode(e),t)}}}}}const w=new RegExp("^<(\\w+)>$"),v=new RegExp("^(\\w+)\\[(\\w+)=(\\w+)]$");class k{constructor(e,n){t(e instanceof Element),t(Array.isArray(n)),this.container=new g(e,n)}get element(){return this.container.element}attr(e){t("object"==typeof e);for(const t in e){const n=e[t];if(n instanceof l){const e=this,i=f(this.element,(()=>e.element.setAttribute(t,n.read())));i.description=`Reactive attribute ${this.element.tagName}.${t} = ${n}`,i.execute()}else this.element.setAttribute(t,n)}return this}prop(e){t("object"==typeof e);for(const t in e){const n=e[t];if(n instanceof l){const e=this,i=f(this.element,(()=>e.element[t]=n.read()));i.description=`Reactive prop ${this.element.tagName}.${t} = ${n}`,i.execute()}else this.element[t]=n}return this}bind(t){return b(this.element,t),this}on(t,e,n){if("string"==typeof t&&"function"==typeof e){const i=w.exec(t);i&&(t=`keydown[key=${i[1]}]`);const s=v.exec(t);if(s){const t=s[1],i=s[2],r=s[3];d(this.element,t,(function(t){t[i]&&t[i]==r&&e.call(this,t)}),n)}else d(this.element,t,e,n)}else d(this.element,t,e,n);return this}}function x(e,n){return t("string"==typeof e),t(e.length>0),function(...t){const i=document.createElement(e),s=new k(i,t);return n&&s.attr(n),s}}function E(t){return(...e)=>new k(t,e)}function $(t){if("string"==typeof t){if(t.startsWith("#")){const e=document.getElementById(t.slice(1));if(null===e)throw new Error("element not found");return E(e)}return x(t)}if(t instanceof Element)return E(t);throw new Error("invalid argument")}function S(t,e){const n=document.createElement(t);if("object"==typeof e)for(const t in e)n.setAttribute(t,e[t]);return function(...t){return n.append(...t.flat(1/0)),n}}function _(t){return S("tr")(S("td",{colspan:"6",style:"background-color: #000; color: #fff"})(t??""))}function C(t){return S("tr",{style:"border-bottom: 1px solid #666"})(S("td",{colspan:"6",style:"background-color: #ccc"})(t??""))}function N(t,n,i,s,r,o){if(n instanceof e){const t=n;n=t.cnt,i=t.sum,s=t.vmin,r=t.vmax,o=t.avg.toFixed(1)}const a="text-align: center; background-color: #6666cc";return S("tr")(S("td",{style:"background-color: #999999; color: #000"})(t??""),S("td",{style:"text-align: center; background-color: #cccc66"})(n??""),S("td",{style:a})(i??""),S("td",{style:a})(s??""),S("td",{style:a})(r??""),S("td",{style:a})(o??""))}function A({tags:t=!0,details:e=!1}={}){return S("table",{style:"border-collapse: collapse; font-family: monospace; font-size: 12px; width: 100%"})(N("metric","cnt","sum","min","max","avg"),_("Registry:Events"),...h.map((t=>[C(`${t[0].tagName}.on${t[1]} --- ${t[2]}`)])),_("Registry:Callbacks"),...p.map((t=>[C(`${t[0].tagName} >>> ${t[1].description??t[1].callback}`)])),t?_("Tags"):"",_(`Values: ${c.length}`),...c.map((t=>[C(`[${typeof t.value}] ${t.value}`),e?N("callbacks",t.callbacks.size):"",e?N("reads",t.readStats):"",e?N("writes",t.writeStats):"",e?N("changes",t.changedStats):""])),_(`Callbacks: ${r.length}`),...r.map((t=>[C(`${t}`),e?N("execute",t.executeStats):""])))}$.a=x("a"),$.abbr=x("abbr"),$.address=x("address"),$.area=x("area"),$.article=x("article"),$.aside=x("aside"),$.audio=x("audio"),$.b=x("b"),$.base=x("base"),$.bdi=x("bdi"),$.bdo=x("bdo"),$.blockquote=x("blockquote"),$.body=x("body"),$.br=x("br"),$.button=x("button"),$.canvas=x("canvas"),$.caption=x("caption"),$.cite=x("cite"),$.code=x("code"),$.col=x("col"),$.colgroup=x("colgroup"),$.data=x("data"),$.datalist=x("datalist"),$.dd=x("dd"),$.del=x("del"),$.details=x("details"),$.dfn=x("dfn"),$.dialog=x("dialog"),$.div=x("div"),$.dl=x("dl"),$.dt=x("dt"),$.em=x("em"),$.embed=x("embed"),$.fieldset=x("fieldset"),$.figcaption=x("figcaption"),$.figure=x("figure"),$.footer=x("footer"),$.form=x("form"),$.h1=x("h1"),$.h2=x("h2"),$.h3=x("h3"),$.h4=x("h4"),$.h5=x("h5"),$.h6=x("h6"),$.head=x("head"),$.header=x("header"),$.hgroup=x("hgroup"),$.hr=x("hr"),$.html=x("html"),$.i=x("i"),$.iframe=x("iframe"),$.img=x("img"),$.input=x("input"),$.ins=x("ins"),$.kbd=x("kbd"),$.label=x("label"),$.legend=x("legend"),$.li=x("li"),$.link=x("link"),$.main=x("main"),$.map=x("map"),$.mark=x("mark"),$.math=x("math"),$.menu=x("menu"),$.meta=x("meta"),$.meter=x("meter"),$.nav=x("nav"),$.noscript=x("noscript"),$.object=x("object"),$.ol=x("ol"),$.optgroup=x("optgroup"),$.option=x("option"),$.output=x("output"),$.p=x("p"),$.picture=x("picture"),$.pre=x("pre"),$.progress=x("progress"),$.q=x("q"),$.rp=x("rp"),$.rt=x("rt"),$.ruby=x("ruby"),$.s=x("s"),$.samp=x("samp"),$.script=x("script"),$.search=x("search"),$.section=x("section"),$.select=x("select"),$.slot=x("slot"),$.small=x("small"),$.source=x("source"),$.span=x("span"),$.strong=x("strong"),$.style=x("style"),$.sub=x("sub"),$.summary=x("summary"),$.sup=x("sup"),$.svg=x("svg"),$.table=x("table"),$.tbody=x("tbody"),$.td=x("td"),$.template=x("template"),$.textarea=x("textarea"),$.tfoot=x("tfoot"),$.th=x("th"),$.thead=x("thead"),$.time=x("time"),$.title=x("title"),$.tr=x("tr"),$.track=x("track"),$.u=x("u"),$.ul=x("ul"),$.var=x("var"),$.video=x("video"),$.wbr=x("wbr"),$.input_hidden=x("input",{type:"hidden"}),$.input_text=x("input",{type:"text"}),$.input_search=x("input",{type:"search"}),$.input_tel=x("input",{type:"tel"}),$.input_url=x("input",{type:"url"}),$.input_email=x("input",{type:"email"}),$.input_password=x("input",{type:"password"}),$.input_date=x("input",{type:"date"}),$.input_month=x("input",{type:"month"}),$.input_week=x("input",{type:"week"}),$.input_time=x("input",{type:"time"}),$.input_datetime_local=x("input",{type:"datetime-local"}),$.input_number=x("input",{type:"number"}),$.input_range=x("input",{type:"range"}),$.input_color=x("input",{type:"color"}),$.input_checkbox=x("input",{type:"checkbox"}),$.input_radio=x("input",{type:"radio"}),$.input_file=x("input",{type:"file"}),$.input_submit=x("input",{type:"submit"}),$.input_image=x("input",{type:"image"}),$.input_reset=x("input",{type:"reset"}),$.input_button=x("input",{type:"button"}),$.IF=function(t){return t instanceof l?(...e)=>()=>t.read()?e:[]:(...e)=>t?e:[]};export{a as newCallback,$ as newTag,u as newValue,A as report};
