function t(t,e){if(!t)throw new Error(e??"assert fail")}class e{constructor(){this.cnt=0,this.sum=0,this.vmin=null,this.vmax=null,this.avg=0}counter(){this.cnt++}update(t){this.cnt++,this.sum+=t,this.vmin=null===this.vmin?t:Math.min(t,this.vmin),this.vmax=null===this.vmax?t:Math.max(t,this.vmax),this.avg=this.cnt>0?this.sum/this.cnt:0}}const n=new class{#t=[];constructor(){}push(t){this.#t.push(t)}pop(){if(0===this.#t.length)throw new Error("unbalanced stack");return this.#t.pop()}get length(){return this.#t.length}get current(){return this.#t[this.#t.length-1]}};var i=!1;const s=Symbol("stop"),r=[];class o{stopped=!1;description;userCallback;constructor(n){t(n instanceof Function),this.callback=n,i&&(this.executeStats=new e,r.push(this))}execute(...t){if(this.stopped)return s;const e=performance.now();n.push(this);try{return this.callback(...t)}finally{n.pop(),this.executeStats&&this.executeStats.update(performance.now()-e)}}}function a(t){return new o(t)}const c=[];class l{constructor(t){this.initialValue=t,this.value=t,this.callbacks=new Set,this.resetBound=this.reset.bind(this),i&&(this.readStats=new e,this.writeStats=new e,this.changedStats=new e,c.push(this))}capture(){n.current&&this.callbacks.add(n.current)}reset(){this.value=this.initialValue,this.changed()}read(){return this.readStats&&this.readStats.counter(),this.capture(),this.value}write(t,{force:e=!1}={}){if(n.length>0)throw new Error("write used inside a reactive callback");return this.writeStats&&this.writeStats.counter(),(this.value!==t||e)&&(this.value=t,this.changed()),this.value}changed(){const t=performance.now(),e=[];for(const t of this.callbacks)t.execute()===s&&e.push(t);for(const t of e)this.callbacks.delete(t);this.changedStats&&this.changedStats.update(performance.now()-t)}map(t){if(this.capture(),Array.isArray(this.value))return this.value.map(t);throw new Error("no array")}toString(){return this.capture(),String(this.value)}}function u(t){return new l(t)}let h=[],p=[];function d(t,e,n,i){t.addEventListener(e,n,i),h.push([t,e,n,i])}function f(e,n){t(n instanceof Function);const i=new o(n);return p.push([e,i]),i}function m(t){for(const e of h)e[0]===t&&e[0].removeEventListener(e[1],e[2],e[3]);for(const e of p)e[0]===t&&(e[1].stopped=!0,e[1].callback=null,e[1].description=null,e[1].userCallback=null);h=h.filter((e=>e[0]!==t)),p=p.filter((e=>e[0]!==t))}function b(e,n){t(e instanceof Element),t(n instanceof l),e instanceof HTMLInputElement?function(t,e){const n=`${t.tagName}[type=${t.type}].bind(${e.value})`;if(t.matches('[type="checkbox"]')){const i=()=>t.checked=e.read();d(t,"change",(()=>e.write(t.checked)));const s=f(t,i);s.description=n,s.execute()}else{const i=()=>t.value=e.read();d(t,"input",(()=>e.write(t.value)));const s=f(t,i);s.description=n,s.execute()}}(e,n):e instanceof HTMLSelectElement&&function(t,e){const n=`${t.tagName}.bind(${e.value})`;if(t.multiple);else{const i=()=>t.value=e.read();d(t,"change",(()=>e.write(t.value)));const s=f(t,i);s.description=n,s.execute()}}(e,n)}class g{constructor(e,n){t(e instanceof Element),t(Array.isArray(n)),this.element=e,this.initialChildCount=e.childNodes.length,this.childs=n.flat(1/0).map((t=>"function"==typeof t?new y(this,t):t)),this.#e()}#e(){for(const t of this.childs)t instanceof y?t.callback.execute():t&&t.container instanceof g?this.element.append(t.container.element):this.element.append(t);this.check()}#n(){return this.childs.reduce(((t,e)=>t+(e instanceof y?e.clen:1)),this.initialChildCount)}check(){const t=this.element.childNodes.length,e=this.#n();if(t!==e)throw new Error(`element desync current=${t} render=${e}`)}}class y{constructor(t,e){this.container=t,this.userCallback=e,this.firstInvocation=!0,this.clen=0,this.callback=f(t.element,(()=>this.#i())),this.callback.userCallback=e}#s(){let t=this.container.element.firstChild;if(null===t)return null;let e=this.container.initialChildCount;for(;e--;){if(null===t)throw new Error("child expected");t=t.nextSibling}e=0;for(const n of this.container.childs){if(n===this){for(;e--;){if(null===t)throw new Error("child expected");t=t.nextSibling}return t}e+=n instanceof y?n.clen:1}throw new Error("function not found")}#i(){t(this instanceof y),this.firstInvocation||this.container.check();let e=this.clen;const n=[this.userCallback()].flat(1/0);this.clen=n.length;for(let t=0;t<n.length;t++)n[t]&&n[t].container instanceof g&&(n[t]=n[t].container.element);if(this.firstInvocation)this.firstInvocation=!1,n.length>0&&this.container.element.append(...n);else{let t=this.#s();if(null===t)this.container.element.append(...n);else{for(;e--;){if(null===t)throw new Error("child expected");const e=t;if(t=t.nextSibling,null===e.parentNode)throw new Error("parentNode is null");e.parentNode.removeChild(e),m(e)}if(n.length>0)if(null===t)this.container.element.append(...n);else{if(null===t.parentNode)throw new Error("parentNode is null");for(const e of n)e instanceof Node?t.parentNode.insertBefore(e,t):t.parentNode.insertBefore(document.createTextNode(e),t)}}}}}const w=new RegExp("^<(\\w+)>$"),k=new RegExp("^(\\w+)\\[(\\w+)=(\\w+)]$");class v{constructor(e,n){t(e instanceof Element),t(Array.isArray(n)),this.container=new g(e,n)}get element(){return this.container.element}attr(e){t("object"==typeof e);for(const t in e){const n=e[t];if(n instanceof l){const e=this,i=f(this.element,(()=>e.element.setAttribute(t,n.read())));i.description=`Reactive attribute ${this.element.tagName}.${t} = ${n}`,i.execute()}else this.element.setAttribute(t,n)}return this}prop(e){t("object"==typeof e);for(const t in e){const n=e[t];if(n instanceof l){const e=this,i=f(this.element,(()=>e.element[t]=n.read()));i.description=`Reactive prop ${this.element.tagName}.${t} = ${n}`,i.execute()}else this.element[t]=n}return this}bind(t){return b(this.element,t),this}on(t,e,n){if("string"==typeof t&&"function"==typeof e){const i=w.exec(t);i&&(t=`keydown[key=${i[1]}]`);const s=k.exec(t);if(s){const t=s[1],i=s[2],r=s[3];d(this.element,t,(function(t){t[i]&&t[i]==r&&e.call(this,t)}),n)}else d(this.element,t,e,n)}else d(this.element,t,e,n);return this}}function x(e,n){return t("string"==typeof e),t(e.length>0),function(...t){const i=document.createElement(e),s=new v(i,t);return n&&s.attr(n),s}}function E(t){return(...e)=>new v(t,e)}function S(t){if("string"==typeof t){if(t.startsWith("#")){const e=document.getElementById(t.slice(1));if(null===e)throw new Error("element not found");return E(e)}return x(t)}if(t instanceof Element)return E(t);throw new Error("invalid argument")}function $(t,e){const n=document.createElement(t);if("object"==typeof e)for(const t in e)n.setAttribute(t,e[t]);return function(...t){return n.append(...t.flat(1/0)),n}}function _(t){return $("tr")($("td",{colspan:"6",style:"background-color: #000; color: #fff"})(t??""))}function C(t){return $("tr",{style:"border-bottom: 1px solid #666"})($("td",{colspan:"6",style:"background-color: #ccc"})(t??""))}function N(t,n,i,s,r,o){if(n instanceof e){const t=n;n=t.cnt,i=t.sum,s=t.vmin,r=t.vmax,o=t.avg.toFixed(1)}const a="text-align: center; background-color: #6666cc";return $("tr")($("td",{style:"background-color: #999999; color: #000"})(t??""),$("td",{style:"text-align: center; background-color: #cccc66"})(n??""),$("td",{style:a})(i??""),$("td",{style:a})(s??""),$("td",{style:a})(r??""),$("td",{style:a})(o??""))}function A(t){return t.description?"function"==typeof t.description?t.description():t.description:t.userCallback?String(t.userCallback):String(t.callback)}function I({tags:t=!0,details:e=!1}={}){return $("table",{style:"border-collapse: collapse; font-family: monospace; font-size: 12px; width: 100%"})(N("metric","cnt","sum","min","max","avg"),_("Events"),...h.map((t=>[C(`${t[0].tagName}.on${t[1]} >>> ${t[2]}`)])),_("Callbacks"),...p.map((t=>[C(`${t[0].tagName} >>> ${t[1].callback}`)])),t?_("Tags"):"",_(`Values: ${c.length}`),...c.map((t=>[C(`[${typeof t.value}] ${t.value}`),e?N("callbacks",t.callbacks.size):"",e?N("reads",t.readStats):"",e?N("writes",t.writeStats):"",e?N("changes",t.changedStats):""])),_(`Callbacks: ${r.length}`),...r.map((t=>[C(A(t)),e?N("execute",t.executeStats):""])))}S.a=x("a"),S.abbr=x("abbr"),S.address=x("address"),S.area=x("area"),S.article=x("article"),S.aside=x("aside"),S.audio=x("audio"),S.b=x("b"),S.base=x("base"),S.bdi=x("bdi"),S.bdo=x("bdo"),S.blockquote=x("blockquote"),S.body=x("body"),S.br=x("br"),S.button=x("button"),S.canvas=x("canvas"),S.caption=x("caption"),S.cite=x("cite"),S.code=x("code"),S.col=x("col"),S.colgroup=x("colgroup"),S.data=x("data"),S.datalist=x("datalist"),S.dd=x("dd"),S.del=x("del"),S.details=x("details"),S.dfn=x("dfn"),S.dialog=x("dialog"),S.div=x("div"),S.dl=x("dl"),S.dt=x("dt"),S.em=x("em"),S.embed=x("embed"),S.fieldset=x("fieldset"),S.figcaption=x("figcaption"),S.figure=x("figure"),S.footer=x("footer"),S.form=x("form"),S.h1=x("h1"),S.h2=x("h2"),S.h3=x("h3"),S.h4=x("h4"),S.h5=x("h5"),S.h6=x("h6"),S.head=x("head"),S.header=x("header"),S.hgroup=x("hgroup"),S.hr=x("hr"),S.html=x("html"),S.i=x("i"),S.iframe=x("iframe"),S.img=x("img"),S.input=x("input"),S.ins=x("ins"),S.kbd=x("kbd"),S.label=x("label"),S.legend=x("legend"),S.li=x("li"),S.link=x("link"),S.main=x("main"),S.map=x("map"),S.mark=x("mark"),S.math=x("math"),S.menu=x("menu"),S.meta=x("meta"),S.meter=x("meter"),S.nav=x("nav"),S.noscript=x("noscript"),S.object=x("object"),S.ol=x("ol"),S.optgroup=x("optgroup"),S.option=x("option"),S.output=x("output"),S.p=x("p"),S.picture=x("picture"),S.pre=x("pre"),S.progress=x("progress"),S.q=x("q"),S.rp=x("rp"),S.rt=x("rt"),S.ruby=x("ruby"),S.s=x("s"),S.samp=x("samp"),S.script=x("script"),S.search=x("search"),S.section=x("section"),S.select=x("select"),S.slot=x("slot"),S.small=x("small"),S.source=x("source"),S.span=x("span"),S.strong=x("strong"),S.style=x("style"),S.sub=x("sub"),S.summary=x("summary"),S.sup=x("sup"),S.svg=x("svg"),S.table=x("table"),S.tbody=x("tbody"),S.td=x("td"),S.template=x("template"),S.textarea=x("textarea"),S.tfoot=x("tfoot"),S.th=x("th"),S.thead=x("thead"),S.time=x("time"),S.title=x("title"),S.tr=x("tr"),S.track=x("track"),S.u=x("u"),S.ul=x("ul"),S.var=x("var"),S.video=x("video"),S.wbr=x("wbr"),S.input_hidden=x("input",{type:"hidden"}),S.input_text=x("input",{type:"text"}),S.input_search=x("input",{type:"search"}),S.input_tel=x("input",{type:"tel"}),S.input_url=x("input",{type:"url"}),S.input_email=x("input",{type:"email"}),S.input_password=x("input",{type:"password"}),S.input_date=x("input",{type:"date"}),S.input_month=x("input",{type:"month"}),S.input_week=x("input",{type:"week"}),S.input_time=x("input",{type:"time"}),S.input_datetime_local=x("input",{type:"datetime-local"}),S.input_number=x("input",{type:"number"}),S.input_range=x("input",{type:"range"}),S.input_color=x("input",{type:"color"}),S.input_checkbox=x("input",{type:"checkbox"}),S.input_radio=x("input",{type:"radio"}),S.input_file=x("input",{type:"file"}),S.input_submit=x("input",{type:"submit"}),S.input_image=x("input",{type:"image"}),S.input_reset=x("input",{type:"reset"}),S.input_button=x("input",{type:"button"}),S.IF=function(t){return t instanceof l?(...e)=>()=>t.read()?e:[]:(...e)=>t?e:[]};export{a as newCallback,S as newTag,u as newValue,I as report};
